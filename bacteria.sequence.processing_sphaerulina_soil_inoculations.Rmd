---
title: "septoria_in_a_bag_16s_data"
output: html_document
date: "2024-01-21"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Project Summary** 

The following code describes the sequence processing steps used to analyze **v4** data generated for the **septora-in-a-bag** project. Data comes from DNA extracted from soils. Soils were collected from pots that were amended with either a natural forest soil or an autoclaved forest soil. After soil amendments, *Populus trichocarpa* (black cottonwood) was planted in a subset of pots. The two different strains *Septoria musiva* (AKA *Sphaerulina musiva*) were added to pots. One strain was determined to be high virulence and the other was determined to be low virulence. Soils were collected from three different locations within the pots. 

**Treatments**

**Inoculum Type**

1. **No Septoria** == NoSept
2. **High Virulence Septoria** == Mn5
3. **Low Virulence Septoria** == SARM07

**Sampling Date**

1. **Day 10** == D10
2. **Day 25** == D25

**Soil Amendment Type**

1. **Autoclaved/Reduced Soil Community** == A
2. **Not-Autoclaved/Full Community** == NA

**Plant Presence**

1. **No Plant in Pot** == NP
2. **Plant in Pot** == P

**Soil Collection Location**

1. **Near Root** == NR
2. **Middle of Pot** == MoP
3. **Edge of Pot** == EoP


## **Load Packages**
Below I load in the packages required to complete the sequence processing and statistical analyses. 
```{r}
#Load Packages
library(dada2)
library(Biostrings)
library(ShortRead)
library(reticulate)

```

# **Sequence Processing**

**Should have xxx forward and reverse files in this project. **

## **Step 1: Path Designations and Quality Assessment**
First I designate the path for the directory that contains the raw v4 sequence data. I then create two objects, one for forward paths and the other for reverse paths. I then assess quality of raw data. 
```{r}
# Creates an object that has the pathway for the sequence directory
soil_v4_path_p2<-"/Users/5io/Documents/septoria_in_a_bag/v4_data/sequence_data/221011_Cregger_AC_SEED_Jo-Soil_Final_P2-16s_KJY9J/BaseCalls"

# Lists the files present in the sequence directory
list.files(soil_v4_path_p2)

# Creates objects for the forward and reverse reads
forwardreads_v4_soil_p2<-sort(list.files(soil_v4_path_p2, pattern="R1_001",full.names=TRUE))
reversereads_v4_soil_p2<-sort(list.files(soil_v4_path_p2, pattern="R2_001",full.names=TRUE))

# Checks number of forward and reverse files. Should be an equal number of forward and reverse files.
length(forwardreads_v4_soil_p2)
length(reversereads_v4_soil_p2)

# Creates an object  that strips away the pathway information leaving behind only the filename. 
filebasename_v4_soil_p2<-basename(forwardreads_v4_soil_p2)

#  Uses the sub function to strip out the general file info to create sample names that are reflective of sample names in metadata sheet. 
basename_v4_soil_p2<-sub("-16S_.*","_D10",filebasename_v4_soil_p2)

# Uses gsub to substitute the - for the _ which is used in the metadata sheet. 
samplenames_v4_soil_p2<-gsub("\\-","_",basename_v4_soil_p2)

unique(samplenames_v4_soil_p2)

# Generates quality plots to assess read quality. 
forward_qual_plot_v4_soil_raw_p2<-plotQualityProfile(forwardreads_v4_soil_p2,aggregate = TRUE)
forward_qual_plot_v4_soil_raw_p2
reverse_qual_plot_v4_soil_raw_p2<-plotQualityProfile(reversereads_v4_soil_p2,aggregate = TRUE)
reverse_qual_plot_v4_soil_raw_p2

# Creates two path objects that will store the paths for the filtered forward and reverse reads. 
forward.filtN_v4_soil_p2<-file.path(soil_v4_path_p2,"filtN",basename(forwardreads_v4_soil_p2))
reverse.filtN_v4_soil_p2<-file.path(soil_v4_path_p2,"filtN",basename(reversereads_v4_soil_p2))

# Filters forward and reverse reads using the filterAndTrim function. Specifying maxN=0 will indicate that sequences with at least 1 ambiguous base will be removed from the dataset. 
filterAndTrim(forwardreads_v4_soil_p2,forward.filtN_v4_soil_p2,reversereads_v4_soil_p2,reverse.filtN_v4_soil_p2,maxN=0,multithread = TRUE)

# Creates quality profiles for the pre-filtered forward and reverse reads.
filtn_qualplot_fwd_v4_soil_p2<-plotQualityProfile(forward.filtN_v4_soil_p2, aggregate=TRUE)
filtn_qualplot_fwd_v4_soil_p2
filtn_qualplot_rev_v4_soil_p2<-plotQualityProfile(reverse.filtN_v4_soil_p2, aggregate=TRUE)
filtn_qualplot_rev_v4_soil_p2

# Creates strings that contain the forward and reverse primers used in the study.
fwd1<-"GTGCCAGCMGCCGCGGTAA"
fwd2<- "GTGCCAGCMGCWGCGGTAA"
fwd3<- "GTGCCAGCMGCCGCGGTCA"
fwd4<- "GTGKCAGCMGCCGCGGTAA"
rev<- "GGACTACHVGGGTWTCTAAT"

# Creates a function called allorientations to identify all potenital orientations of the primers. Then uses the complement, reverse, and reverseComplement functions to store all possible orientations of the primer in the orientations object). Finally, uses the sapply function to convert all orientations into individual strings of text. 
allorientations<-function(primer){       
  require(Biostrings)     
  dna<-DNAString(primer)                                                    
  orientations<-c(Forward=dna, Complement=Biostrings::complement(dna),Reverse=Biostrings::reverse(dna), 
             RevComp=Biostrings::reverseComplement(dna)) 
  return(sapply(orientations,toString))
}

# Stores all possible orientations of primers in objects for each primer.
fwd1.ori<-allorientations(fwd1)
fwd2.ori<-allorientations(fwd2)
fwd3.ori<-allorientations(fwd3)
fwd4.ori<-allorientations(fwd4)
rev.ori<-allorientations(rev)

# Specifies the conda environment to use for cutadapt
use_condaenv("/Users/5io/anaconda3/envs/cutadaptenv")

# Uses the system2 function to pass commands to the shell to run cutadapt from R. Checking to make sure R can find Cutadapt. 
system2("conda",args=c("run", "-n", "cutadaptenv", "cutadapt", "--version"))

# Creates a directory to store the forward and reverse reads after they have been trimmed. 
path.cut_p2<-file.path(soil_v4_path_p2,"cutadapt")
if(!dir.exists(path.cut_p2)) dir.create(path.cut_p2)

forwardreads.cut_v4_soil_p2<-file.path(path.cut_p2,basename(forwardreads_v4_soil_p2))
reversereads.cut_v4_soil_p2<-file.path(path.cut_p2,basename(reversereads_v4_soil_p2))

# Creates objects containing the forward and reverse primer reverse compliment strings. Calls the rc function of the dada2 package. The rc function takes a sequence object provided by the user and creates the reverse compliment of the sequence. 
fwd.rc1<-dada2:::rc(fwd1)
fwd.rc2<-dada2:::rc(fwd2)
fwd.rc3<-dada2:::rc(fwd3)
fwd.rc4<-dada2:::rc(fwd4) 
rev.rc<-dada2:::rc(rev)

# Uses the paste function to create objects that contain the flags for the potential combinations of each forward and reverse primer and the reverse compliment. These flags will serve as the arguments provided to cutadapt. The ^ at the beginning of the sequence indicates that the primer should be removed from the beginning of the sequence. 

fwd1.r1.flags<-paste("-a"," ", "^", fwd1,"...",rev.rc, sep='') 
fwd2.r1.flags<-paste("-a"," ", "^", fwd2,"...",rev.rc, sep='') 
fwd3.r1.flags<-paste("-a"," ", "^", fwd3,"...",rev.rc, sep='')
fwd4.r1.flags<-paste("-a"," ", "^", fwd4,"...",rev.rc, sep='') 
rev.fwd1.flags<-paste("-A"," ", "^", rev,"...",fwd.rc1, sep='')
rev.fwd2.flags<-paste("-A"," ", "^", rev,"...",fwd.rc2, sep='')
rev.fwd3.flags<-paste("-A"," ", "^", rev,"...",fwd.rc3, sep='')
rev.fwd4.flags<-paste("-A"," ", "^", rev,"...",fwd.rc4, sep='')


# Uses cutadapt to remove the primers from each read. Removing any read that does not have the forward primer or the reverse primer in the correct orientation.
for (i in seq_along(forwardreads_v4_soil_p2)){
  system2("conda",args=c("run -n cutadaptenv cutadapt",
                          fwd1.r1.flags,
                          fwd2.r1.flags,
                          fwd3.r1.flags,
                          fwd4.r1.flags,
                          rev.fwd1.flags,
                          rev.fwd2.flags,
                          rev.fwd3.flags,
                          rev.fwd4.flags,
                          "--discard-untrimmed", "--minimum-length 10",
                          "-o",forwardreads.cut_v4_soil_p2[i], "-p",reversereads.cut_v4_soil_p2[i],
                          forward.filtN_v4_soil_p2[i],reverse.filtN_v4_soil_p2[i]))
}


# Creating new pathways for the quality filtered forward and reverse reads. 
filtforward_v4_soil_p2<-file.path(soil_v4_path_p2, "filtered", (paste0(samplenames_v4_soil_p2,"_F_filt.fastq.gz")))
filtreverse_v4_soil_p2<-file.path(soil_v4_path_p2,"filtered",paste0(samplenames_v4_soil_p2,"_R_filt.fastq.gz"))

#filtforward_v4_soil[duplicated(filtforward_v4_soil)]<-sub("filt.fastq.gz","v2_filt.fastq",filtforward_v4_soil[duplicated(filtforward_v4_soil)])
#filtreverse_v4_soil[duplicated(filtreverse_v4_soil)]<-sub("filt.fastq.gz","v2_filt.fastq",filtreverse_v4_soil[duplicated(filtreverse_v4_soil)])

# Creating quality profiles for the primer trimmed forward and reverse reads. 
primercut_qualplot_fwd_v4_soil_p2<-plotQualityProfile(forwardreads.cut_v4_soil_p2, aggregate=TRUE)
primercut_qualplot_fwd_v4_soil_p2
primercut_qualplot_rev_v4_soil_p2<-plotQualityProfile(reversereads.cut_v4_soil_p2, aggregate=TRUE)
primercut_qualplot_rev_v4_soil_p2

# Quality filtering reads using a maximum expected error threshold of 2 for the forward and reverse reads. 
filter.out_v4_soil_p2<-filterAndTrim(fwd=forwardreads.cut_v4_soil_p2, filt=filtforward_v4_soil_p2, rev=reversereads.cut_v4_soil_p2, filt.rev=filtreverse_v4_soil_p2, maxEE=c(2,2), compress=FALSE,truncLen = 225, multithread = TRUE)
 
# Converting the filter.out_v4_soil object into a data frame. 
filter.out_v4_soil_p2<-as.data.frame(filter.out_v4_soil_p2)

# Checking to see the effects of the quality filtering on per sample read counts. 
filter.out_v4_soil_p2$diffs <- filter.out_v4_soil_p2$reads.in-filter.out_v4_soil_p2$reads.out

# Using the order command to sort the dataframe by the new column (diffs) that created above. 
filter.out_v4_soil_p2[order(filter.out_v4_soil_p2$reads.out),]


#filtforward_v4_soil_p2<-filtforward_v4_soil_p2[grep("Amp|AMP",filtforward_v4_soil_p2,invert = TRUE)]
#filtreverse_v4_soil_p2<-filtreverse_v4_soil_p2[grep("Amp|AMP",filtreverse_v4_soil_p2,invert = TRUE)]


# Generating quality plots for the forward and reverse reads after quality filtering
filtered_qualplot_fwd_v4_soil_p2<-plotQualityProfile(filtforward_v4_soil_p2, aggregate=TRUE)
filtered_qualplot_fwd_v4_soil_p2
filtered_qualplot_rev_v4_soil_p2<-plotQualityProfile(filtreverse_v4_soil_p2, aggregate=TRUE)
filtered_qualplot_rev_v4_soil_p2

# Dereplicating forward and reverse reads
derepforward_v4_soil_p2<-derepFastq(filtforward_v4_soil_p2,verbose=TRUE)
derepreverse_v4_soil_p2<-derepFastq(filtreverse_v4_soil_p2,verbose=TRUE)

# Learning errors for forward and reverse reads. 
errorforward_v4_soil_p2<-learnErrors(derepforward_v4_soil_p2, multithread = TRUE)
errorreverse_v4_soil_p2<-learnErrors(derepreverse_v4_soil_p2,multithread = TRUE)

# Error plots for forward & reverse reads
errplots_fwd_v4_soil_p2<-plotErrors(errorforward_v4_soil_p2, nominalQ=TRUE)
errplots_fwd_v4_soil_p2
errplots_rev_v4_soil_p2<-plotErrors(errorreverse_v4_soil_p2,nominalQ = TRUE)
errplots_rev_v4_soil_p2


# Denoising with dada2
dadaforwardreads_v4_soil_p2<-dada(derepforward_v4_soil_p2,err=errorforward_v4_soil_p2,multithread = TRUE,pool=TRUE)
dadareversereads.ds_v4_soil_p2<-dada(derepreverse_v4_soil_p2,err=errorreverse_v4_soil_p2,multithread = TRUE,pool=TRUE)


# Merging forward and reverse reads using mergePairs. 
merge_v4_soil_p2<-mergePairs(dadaforwardreads_v4_soil_p2,derepforward_v4_soil_p2,dadareversereads.ds_v4_soil_p2,derepreverse_v4_soil_p2,verbose=TRUE)

# Creating a sequence table
seqtab_v4_soil_p2<-makeSequenceTable(merge_v4_soil_p2)
hist(nchar(colnames(seqtab_v4_soil_p2)))
```


```{r}
# Creates an object that has the pathway for the sequence directory
soil_v4_path_p1<-"/Users/5io/Documents/septoria_in_a_bag/v4_data/sequence_data/221005_Cregger_AC_SEED_Jo_Soil_Final_P1-16s_KJYGW/BaseCalls"

# Lists the files present in the sequence directory
list.files(soil_v4_path_p1)

# Creates objects for the forward and reverse reads
forwardreads_v4_soil_p1<-sort(list.files(soil_v4_path_p1, pattern="R1_001",full.names=TRUE))
reversereads_v4_soil_p1<-sort(list.files(soil_v4_path_p1, pattern="R2_001",full.names=TRUE))

# Checks number of forward and reverse files. Should be an equal number of forward and reverse files.
length(forwardreads_v4_soil_p1)
length(reversereads_v4_soil_p1)

# Creates an object  that strips away the pathway information leaving behind only the filename. 
filebasename_v4_soil_p1<-basename(forwardreads_v4_soil_p1)

#  Uses the sub function to strip out the general file info to create sample names that are reflective of sample names in metadata sheet. 
basename_v4_soil_p1<-sub("-16S_.*","_D25",filebasename_v4_soil_p1)

# Uses gsub to substitute the - for the _ which is used in the metadata sheet. 
samplenames_v4_soil_p1<-gsub("\\-","_",basename_v4_soil_p1)

unique(samplenames_v4_soil_p1)
# Generates quality plots to assess read quality. 
forward_qual_plot_v4_soil_raw_p1<-plotQualityProfile(forwardreads_v4_soil_p1,aggregate = TRUE)
forward_qual_plot_v4_soil_raw_p1
reverse_qual_plot_v4_soil_raw_p1<-plotQualityProfile(reversereads_v4_soil_p1,aggregate = TRUE)
reverse_qual_plot_v4_soil_raw_p1

# Creates two path objects that will store the paths for the filtered forward and reverse reads. 
forward.filtN_v4_soil_p1<-file.path(soil_v4_path_p1,"filtN",basename(forwardreads_v4_soil_p1))
reverse.filtN_v4_soil_p1<-file.path(soil_v4_path_p1,"filtN",basename(reversereads_v4_soil_p1))

# Filters forward and reverse reads using the filterAndTrim function. Specifying maxN=0 will indicate that sequences with at least 1 ambiguous base will be removed from the dataset. 
filterAndTrim(forwardreads_v4_soil_p1,forward.filtN_v4_soil_p1,reversereads_v4_soil_p1,reverse.filtN_v4_soil_p1,maxN=0,multithread = FALSE)

# Creates quality profiles for the pre-filtered forward and reverse reads.
filtn_qualplot_fwd_v4_soil_p1<-plotQualityProfile(forward.filtN_v4_soil_p1, aggregate=TRUE)
filtn_qualplot_fwd_v4_soil_p1
filtn_qualplot_rev_v4_soil_p1<-plotQualityProfile(reverse.filtN_v4_soil_p1, aggregate=TRUE)
filtn_qualplot_rev_v4_soil_p1

# Creates strings that contain the forward and reverse primers used in the study.
fwd1<-"GTGCCAGCMGCCGCGGTAA"
fwd2<- "GTGCCAGCMGCWGCGGTAA"
fwd3<- "GTGCCAGCMGCCGCGGTCA"
fwd4<- "GTGKCAGCMGCCGCGGTAA"
rev<- "GGACTACHVGGGTWTCTAAT"

# Creates a function called allorientations to identify all potenital orientations of the primers. Then uses the complement, reverse, and reverseComplement functions to store all possible orientations of the primer in the orientations object). Finally, uses the sapply function to convert all orientations into individual strings of text. 
allorientations<-function(primer){       
  require(Biostrings)     
  dna<-DNAString(primer)                                                    
  orientations<-c(Forward=dna, Complement=Biostrings::complement(dna),Reverse=Biostrings::reverse(dna), 
             RevComp=Biostrings::reverseComplement(dna)) 
  return(sapply(orientations,toString))
}

# Stores all possible orientations of primers in objects for each primer.
fwd1.ori<-allorientations(fwd1)
fwd2.ori<-allorientations(fwd2)
fwd3.ori<-allorientations(fwd3)
fwd4.ori<-allorientations(fwd4)
rev.ori<-allorientations(rev)


# Specifies the conda environment to use for cutadapt
use_condaenv("/Users/5io/anaconda3/envs/cutadaptenv")

# Uses the system2 function to pass commands to the shell to run cutadapt from R. Checking to make sure R can find Cutadapt. 
system2("conda",args=c("run", "-n", "cutadaptenv", "cutadapt", "--version"))

# Creates a directory to store the forward and reverse reads after they have been trimmed. 
path.cut_p1<-file.path(soil_v4_path_p1,"cutadapt")
if(!dir.exists(path.cut_p1)) dir.create(path.cut_p1)

forwardreads.cut_v4_soil_p1<-file.path(path.cut_p1,basename(forwardreads_v4_soil_p1))
reversereads.cut_v4_soil_p1<-file.path(path.cut_p1,basename(reversereads_v4_soil_p1))

# Creates objects containing the forward and reverse primer reverse compliment strings. Calls the rc function of the dada2 package. The rc function takes a sequence object provided by the user and creates the reverse compliment of the sequence. 
fwd.rc1<-dada2:::rc(fwd1)
fwd.rc2<-dada2:::rc(fwd2)
fwd.rc3<-dada2:::rc(fwd3)
fwd.rc4<-dada2:::rc(fwd4) 
rev.rc<-dada2:::rc(rev)

# Uses the paste function to create objects that contain the flags for the potential combinations of each forward and reverse primer and the reverse compliment. These flags will serve as the arguments provided to cutadapt. The ^ at the beginning of the sequence indicates that the primer should be removed from the beginning of the sequence. 

fwd1.r1.flags<-paste("-a"," ", "^", fwd1,"...",rev.rc, sep='') 
fwd2.r1.flags<-paste("-a"," ", "^", fwd2,"...",rev.rc, sep='') 
fwd3.r1.flags<-paste("-a"," ", "^", fwd3,"...",rev.rc, sep='')
fwd4.r1.flags<-paste("-a"," ", "^", fwd4,"...",rev.rc, sep='') 
rev.fwd1.flags<-paste("-A"," ", "^", rev,"...",fwd.rc1, sep='')
rev.fwd2.flags<-paste("-A"," ", "^", rev,"...",fwd.rc2, sep='')
rev.fwd3.flags<-paste("-A"," ", "^", rev,"...",fwd.rc3, sep='')
rev.fwd4.flags<-paste("-A"," ", "^", rev,"...",fwd.rc4, sep='')


# Uses cutadapt to remove the primers from each read. Removing any read that does not have the forward primer or the reverse primer in the correct orientation.
for (i in seq_along(forwardreads_v4_soil_p1)){
  system2("conda",args=c("run -n cutadaptenv cutadapt",
                          fwd1.r1.flags,
                          fwd2.r1.flags,
                          fwd3.r1.flags,
                          fwd4.r1.flags,
                          rev.fwd1.flags,
                          rev.fwd2.flags,
                          rev.fwd3.flags,
                          rev.fwd4.flags,
                          "--discard-untrimmed", "--minimum-length 10",
                          "-o",forwardreads.cut_v4_soil_p1[i], "-p",reversereads.cut_v4_soil_p1[i],
                          forward.filtN_v4_soil_p1[i],reverse.filtN_v4_soil_p1[i]))
}

# Creating new pathways for the quality filtered forward and reverse reads. 
filtforward_v4_soil_p1<-file.path(soil_v4_path_p1, "filtered", (paste0(samplenames_v4_soil_p1,"_F_filt.fastq.gz")))
filtreverse_v4_soil_p1<-file.path(soil_v4_path_p1,"filtered",paste0(samplenames_v4_soil_p1,"_R_filt.fastq.gz"))

# Creating quality profiles for the primer trimmed forward and reverse reads. 
primercut_qualplot_fwd_v4_soil_p1<-plotQualityProfile(forwardreads.cut_v4_soil_p1, aggregate=TRUE)
primercut_qualplot_fwd_v4_soil_p1
primercut_qualplot_rev_v4_soil_p1<-plotQualityProfile(reversereads.cut_v4_soil_p1, aggregate=TRUE)
primercut_qualplot_rev_v4_soil_p1

# Quality filtering reads using a maximum expected error threshold of 2 for the forward and reverse reads. 
filter.out_v4_soil_p1<-filterAndTrim(fwd=forwardreads.cut_v4_soil_p1, filt=filtforward_v4_soil_p1, rev=reversereads.cut_v4_soil_p1, filt.rev=filtreverse_v4_soil_p1, maxEE=c(2,2), compress=FALSE,truncLen = 225, multithread = FALSE)
 
# Converting the filter.out_v4_soil object into a data frame. 
filter.out_v4_soil_p1<-as.data.frame(filter.out_v4_soil_p1)

# Checking to see the effects of the quality filtering on per sample read counts. 
filter.out_v4_soil_p1$diffs <- filter.out_v4_soil_p1$reads.in-filter.out_v4_soil_p1$reads.out

# Using the order command to sort the dataframe by the new column (diffs) that created above. 
filter.out_v4_soil_p1[order(filter.out_v4_soil_p1$reads.out),]

#filtforward_v4_soil_p1<-filtforward_v4_soil_p1[grep("Amp|AMP",filtforward_v4_soil_p1,invert = TRUE)]
#filtreverse_v4_soil_p1<-filtreverse_v4_soil_p1[grep("Amp|AMP",filtreverse_v4_soil_p1,invert = TRUE)]

# Generating quality plots for the forward and reverse reads after quality filtering
filtered_qualplot_fwd_v4_soil_p1<-plotQualityProfile(filtforward_v4_soil_p1, aggregate=TRUE)
filtered_qualplot_fwd_v4_soil_p1
filtered_qualplot_rev_v4_soil_p1<-plotQualityProfile(filtreverse_v4_soil_p1, aggregate=TRUE)
filtered_qualplot_rev_v4_soil_p1

# Dereplicating forward and reverse reads
derepforward_v4_soil_p1<-derepFastq(filtforward_v4_soil_p1,verbose=TRUE)
derepreverse_v4_soil_p1<-derepFastq(filtreverse_v4_soil_p1,verbose=TRUE)

# Learning errors for forward and reverse reads. 
errorforward_v4_soil_p1<-learnErrors(derepforward_v4_soil_p1, multithread = TRUE)
errorreverse_v4_soil_p1<-learnErrors(derepreverse_v4_soil_p1,multithread = TRUE)

# Error plots for forward & reverse reads
errplots_fwd_v4_soil_p1<-plotErrors(errorforward_v4_soil_p1, nominalQ=TRUE)
errplots_fwd_v4_soil_p1
errplots_rev_v4_soil_p1<-plotErrors(errorreverse_v4_soil_p1,nominalQ = TRUE)
errplots_rev_v4_soil_p1


# Denoising with dada2
dadaforwardreads_v4_soil_p1<-dada(derepforward_v4_soil_p1,err=errorforward_v4_soil_p1,multithread = TRUE,pool=TRUE)
dadareversereads.ds_v4_soil_p1<-dada(derepreverse_v4_soil_p1,err=errorreverse_v4_soil_p1,multithread = TRUE,pool=TRUE)


# Merging forward and reverse reads using mergePairs. 
merge_v4_soil_p1<-mergePairs(dadaforwardreads_v4_soil_p1,derepforward_v4_soil_p1,dadareversereads.ds_v4_soil_p1,derepreverse_v4_soil_p1,verbose=TRUE)

# Creating a sequence table
seqtab_v4_soil_p1<-makeSequenceTable(merge_v4_soil_p1)
hist(nchar(colnames(seqtab_v4_soil_p1)))

```


```{r}
# Creates an object that has the pathway for the sequence directory
soil_v4_path_initial<-"/Users/5io/Documents/septoria_in_a_bag/v4_data/sequence_data/230413_M02014_Cregger_AC_SEED_Septoriabag_initial_16s_KJWJG/BaseCalls"

# Lists the files present in the sequence directory
list.files(soil_v4_path_initial)

# Creates objects for the forward and reverse reads
forwardreads_v4_soil_initial<-sort(list.files(soil_v4_path_initial, pattern="R1_001",full.names=TRUE))
reversereads_v4_soil_initial<-sort(list.files(soil_v4_path_initial, pattern="R2_001",full.names=TRUE))

# Checks number of forward and reverse files. Should be an equal number of forward and reverse files.
length(forwardreads_v4_soil_initial)
length(reversereads_v4_soil_initial)

# Creates an object  that strips away the pathway information leaving behind only the filename. 
filebasename_v4_soil_initial<-basename(forwardreads_v4_soil_initial)

#  Uses the sub function to strip out the general file info to create sample names that are reflective of sample names in metadata sheet. 
basename_v4_soil_initial<-sub("-16S_.*","_initial",filebasename_v4_soil_initial)

# Uses gsub to substitute the - for the _ which is used in the metadata sheet. 
samplenames_v4_soil_initial<-gsub("\\-","_",basename_v4_soil_initial)

unique(samplenames_v4_soil_initial)
# Generates quality plots to assess read quality. 
forward_qual_plot_v4_soil_raw_initial<-plotQualityProfile(forwardreads_v4_soil_initial,aggregate = TRUE)
forward_qual_plot_v4_soil_raw_initial
reverse_qual_plot_v4_soil_raw_initial<-plotQualityProfile(reversereads_v4_soil_initial,aggregate = TRUE)
reverse_qual_plot_v4_soil_raw_initial

# Creates two path objects that will store the paths for the filtered forward and reverse reads. 
forward.filtN_v4_soil_initial<-file.path(soil_v4_path_initial,"filtN",basename(forwardreads_v4_soil_initial))
reverse.filtN_v4_soil_initial<-file.path(soil_v4_path_initial,"filtN",basename(reversereads_v4_soil_initial))

# Filters forward and reverse reads using the filterAndTrim function. Specifying maxN=0 will indicate that sequences with at least 1 ambiguous base will be removed from the dataset. 
filterAndTrim(forwardreads_v4_soil_initial,forward.filtN_v4_soil_initial,reversereads_v4_soil_initial,reverse.filtN_v4_soil_initial,maxN=0,multithread = FALSE)

# Creates quality profiles for the pre-filtered forward and reverse reads.
filtn_qualplot_fwd_v4_soil_initial<-plotQualityProfile(forward.filtN_v4_soil_initial, aggregate=TRUE)
filtn_qualplot_fwd_v4_soil_initial
filtn_qualplot_rev_v4_soil_initial<-plotQualityProfile(reverse.filtN_v4_soil_initial, aggregate=TRUE)
filtn_qualplot_rev_v4_soil_initial

# Creates strings that contain the forward and reverse primers used in the study.
fwd1<-"GTGCCAGCMGCCGCGGTAA"
fwd2<- "GTGCCAGCMGCWGCGGTAA"
fwd3<- "GTGCCAGCMGCCGCGGTCA"
fwd4<- "GTGKCAGCMGCCGCGGTAA"
rev<- "GGACTACHVGGGTWTCTAAT"

# Creates a function called allorientations to identify all potenital orientations of the primers. Then uses the complement, reverse, and reverseComplement functions to store all possible orientations of the primer in the orientations object). Finally, uses the sapply function to convert all orientations into individual strings of text. 
allorientations<-function(primer){       
  require(Biostrings)     
  dna<-DNAString(primer)                                                    
  orientations<-c(Forward=dna, Complement=Biostrings::complement(dna),Reverse=Biostrings::reverse(dna), 
             RevComp=Biostrings::reverseComplement(dna)) 
  return(sapply(orientations,toString))
}

# Stores all possible orientations of primers in objects for each primer.
fwd1.ori<-allorientations(fwd1)
fwd2.ori<-allorientations(fwd2)
fwd3.ori<-allorientations(fwd3)
fwd4.ori<-allorientations(fwd4)
rev.ori<-allorientations(rev)

# Specifies the conda environment to use for cutadapt
use_condaenv("/Users/5io/anaconda3/envs/cutadaptenv")

# Uses the system2 function to pass commands to the shell to run cutadapt from R. Checking to make sure R can find Cutadapt. 
system2("conda",args=c("run", "-n", "cutadaptenv", "cutadapt", "--version"))

# Creates a directory to store the forward and reverse reads after they have been trimmed. 
path.cut_initial<-file.path(soil_v4_path_initial,"cutadapt")
if(!dir.exists(path.cut_initial)) dir.create(path.cut_initial)

forwardreads.cut_v4_soil_initial<-file.path(path.cut_initial,basename(forwardreads_v4_soil_initial))
reversereads.cut_v4_soil_initial<-file.path(path.cut_initial,basename(reversereads_v4_soil_initial))

# Creates objects containing the forward and reverse primer reverse compliment strings. Calls the rc function of the dada2 package. The rc function takes a sequence object provided by the user and creates the reverse compliment of the sequence. 
fwd.rc1<-dada2:::rc(fwd1)
fwd.rc2<-dada2:::rc(fwd2)
fwd.rc3<-dada2:::rc(fwd3)
fwd.rc4<-dada2:::rc(fwd4) 
rev.rc<-dada2:::rc(rev)

# Uses the paste function to create objects that contain the flags for the potential combinations of each forward and reverse primer and the reverse compliment. These flags will serve as the arguments provided to cutadapt. The ^ at the beginning of the sequence indicates that the primer should be removed from the beginning of the sequence. 

fwd1.r1.flags<-paste("-a"," ", "^", fwd1,"...",rev.rc, sep='') 
fwd2.r1.flags<-paste("-a"," ", "^", fwd2,"...",rev.rc, sep='') 
fwd3.r1.flags<-paste("-a"," ", "^", fwd3,"...",rev.rc, sep='')
fwd4.r1.flags<-paste("-a"," ", "^", fwd4,"...",rev.rc, sep='') 
rev.fwd1.flags<-paste("-A"," ", "^", rev,"...",fwd.rc1, sep='')
rev.fwd2.flags<-paste("-A"," ", "^", rev,"...",fwd.rc2, sep='')
rev.fwd3.flags<-paste("-A"," ", "^", rev,"...",fwd.rc3, sep='')
rev.fwd4.flags<-paste("-A"," ", "^", rev,"...",fwd.rc4, sep='')


# Uses cutadapt to remove the primers from each read. Removing any read that does not have the forward primer or the reverse primer in the correct orientation.
for (i in seq_along(forwardreads_v4_soil_initial)){
  system2("conda",args=c("run -n cutadaptenv cutadapt",
                          fwd1.r1.flags,
                          fwd2.r1.flags,
                          fwd3.r1.flags,
                          fwd4.r1.flags,
                          rev.fwd1.flags,
                          rev.fwd2.flags,
                          rev.fwd3.flags,
                          rev.fwd4.flags,
                          "--discard-untrimmed", "--minimum-length 10",
                          "-o",forwardreads.cut_v4_soil_initial[i], "-p",reversereads.cut_v4_soil_initial[i],
                          forward.filtN_v4_soil_initial[i],reverse.filtN_v4_soil_initial[i]))
}

# Creating new pathways for the quality filtered forward and reverse reads. 
filtforward_v4_soil_initial<-file.path(soil_v4_path_initial, "filtered", (paste0(samplenames_v4_soil_initial,"_F_filt.fastq.gz")))
filtreverse_v4_soil_initial<-file.path(soil_v4_path_initial,"filtered",paste0(samplenames_v4_soil_initial,"_R_filt.fastq.gz"))

#filtforward_v4_soil[duplicated(filtforward_v4_soil)]<-sub("filt.fastq.gz","v2_filt.fastq",filtforward_v4_soil[duplicated(filtforward_v4_soil)])
#filtreverse_v4_soil[duplicated(filtreverse_v4_soil)]<-sub("filt.fastq.gz","v2_filt.fastq",filtreverse_v4_soil[duplicated(filtreverse_v4_soil)])

# Creating quality profiles for the primer trimmed forward and reverse reads. 
primercut_qualplot_fwd_v4_soil_initial<-plotQualityProfile(forwardreads.cut_v4_soil_initial, aggregate=TRUE)
primercut_qualplot_fwd_v4_soil_initial
primercut_qualplot_rev_v4_soil_initial<-plotQualityProfile(reversereads.cut_v4_soil_initial, aggregate=TRUE)
primercut_qualplot_rev_v4_soil_initial

# Quality filtering reads using a maximum expected error threshold of 2 for the forward and reverse reads. 
filter.out_v4_soil_initial<-filterAndTrim(fwd=forwardreads.cut_v4_soil_initial, filt=filtforward_v4_soil_initial, rev=reversereads.cut_v4_soil_initial, filt.rev=filtreverse_v4_soil_initial, maxEE=c(2,2), compress=FALSE,truncLen = 225, multithread = FALSE)
 
# Converting the filter.out_v4_soil object into a data frame. 
filter.out_v4_soil_initial<-as.data.frame(filter.out_v4_soil_initial)

# Checking to see the effects of the quality filtering on per sample read counts. 
filter.out_v4_soil_initial$diffs <- filter.out_v4_soil_initial$reads.in-filter.out_v4_soil_initial$reads.out

# Using the order command to sort the dataframe by the new column (diffs) that created above. 
filter.out_v4_soil_initial[order(filter.out_v4_soil_initial$reads.out),]


filtforward_v4_soil_initial_no_missing<-filtforward_v4_soil_initial[grep("NTC_Amp1_initial_F_filt.fastq.gz",filtforward_v4_soil_initial,invert = TRUE)]
filtreverse_v4_soil_initial_no_missing<-filtreverse_v4_soil_initial[grep("NTC_Amp1_initial_R_filt.fastq.gz",filtreverse_v4_soil_initial,invert = TRUE)]


# Generating quality plots for the forward and reverse reads after quality filtering
filtered_qualplot_fwd_v4_soil<-plotQualityProfile(filtforward_v4_soil_initial_no_missing, aggregate=TRUE)
filtered_qualplot_fwd_v4_soil
filtered_qualplot_rev_v4_soil<-plotQualityProfile(filtreverse_v4_soil_initial_no_missing, aggregate=TRUE)
filtered_qualplot_rev_v4_soil

# Dereplicating forward and reverse reads
derepforward_v4_soil_initial<-derepFastq(filtforward_v4_soil_initial_no_missing,verbose=TRUE)
derepreverse_v4_soil_initial<-derepFastq(filtreverse_v4_soil_initial_no_missing,verbose=TRUE)

# Learning errors for forward and reverse reads. 
errorforward_v4_soil_initial<-learnErrors(derepforward_v4_soil_initial, multithread = TRUE)
errorreverse_v4_soil_initial<-learnErrors(derepreverse_v4_soil_initial,multithread = TRUE)

# Error plots for forward & reverse reads
errplots_fwd_v4_soil_initial<-plotErrors(errorforward_v4_soil_initial, nominalQ=TRUE)
errplots_fwd_v4_soil_initial
errplots_rev_v4_soil_initial<-plotErrors(errorreverse_v4_soil_initial,nominalQ = TRUE)
errplots_rev_v4_soil_initial


# Denoising with dada2
dadaforwardreads_v4_soil_initial<-dada(derepforward_v4_soil_initial,err=errorforward_v4_soil_initial,multithread = TRUE,pool=TRUE)
dadareversereads.ds_v4_soil_initial<-dada(derepreverse_v4_soil_initial,err=errorreverse_v4_soil_initial,multithread = TRUE,pool=TRUE)


# Merging forward and reverse reads using mergePairs. 
merge_v4_soil_initial<-mergePairs(dadaforwardreads_v4_soil_initial,derepforward_v4_soil_initial,dadareversereads.ds_v4_soil_initial,derepreverse_v4_soil_initial,verbose=TRUE)

# Creating a sequence table
seqtab_v4_soil_initial<-makeSequenceTable(merge_v4_soil_initial)
hist(nchar(colnames(seqtab_v4_soil_initial)))
```


```{r}
# Merging ASV tables from all three runs
merged_sequence_table<-mergeSequenceTables(seqtab_v4_soil_p1,seqtab_v4_soil_p2,seqtab_v4_soil_initial)


# Removing chimeras using the removeBimeraDenovo function.
seqtab.nochim_v4_soil<-removeBimeraDenovo(merged_sequence_table,method="consensus", multithread=TRUE, verbose=TRUE)

# Number of ASVs in the study
ncol((seqtab.nochim_v4_soil))
nrow(seqtab.nochim_v4_soil)

# Number of sequences
sum(seqtab.nochim_v4_soil)

# Assigning taxonomy using the assignTaxonomy function.
taxa_v4_soil<-assignTaxonomy(seqtab.nochim_v4_soil,"~/OneDrive - Oak Ridge National Laboratory/septoria_in_a_bag/v4_data/silva_nr99_v138.1_wSpecies_train_set.fa.gz",multithread = TRUE, minBoot=80)

# Converting the taxonomy assignments to data frame so we can filter the taxonomic assignments.
taxa.original_v4_soil<-as.data.frame(taxa_v4_soil)
nrow(taxa.original_v4_soil)

# Removing chloroplast sequences
taxa.chloroplast.omit_v4_soil<-taxa.original_v4_soil[grep("Chloroplast",taxa.original_v4_soil$Order,invert=TRUE),]
nrow(taxa.chloroplast.omit_v4_soil)

# Removing eukaryote sequences
taxa.euk.omit_v4_soil<-taxa.chloroplast.omit_v4_soil[grep("Eukaryota",taxa.chloroplast.omit_v4_soil$Kingdom,invert=TRUE),]
nrow(taxa.euk.omit_v4_soil)

# Removing mitochondria sequences
taxa.mitochondria.omit_v4_soil<-taxa.euk.omit_v4_soil[grep("Mitochondria",taxa.euk.omit_v4_soil$Family,invert=TRUE),]
nrow(taxa.mitochondria.omit_v4_soil)

# Removing sequences not identified to at least phylum
taxa.na.omit_v4_soil<-taxa.mitochondria.omit_v4_soil[-(which(is.na(taxa.mitochondria.omit_v4_soil$Phylum))),]

# Counting the number of rows which represents the number of ASVs retained following taxonomy filtering.  
nrow(taxa.na.omit_v4_soil)
```

## **Taxonomy Merging and ASV Filtering**
The last step is to filter the ASV abundance table by merging the ASV table with the taxonomy assignments. This will remove ASVs from the count table that were not assigned to a fungal phyla or were identified as nematodes or plant sequences. 
```{r}
# Transposing the ASV table so that taxonomy can be added. 
t.seqtab.nochim_v4_soil<-t(seqtab.nochim_v4_soil)

# Merging the two tables together based on row name. 
t.seqtab.nochim.filt_v4_soil<-t.seqtab.nochim_v4_soil[row.names(t.seqtab.nochim_v4_soil)%in%row.names(taxa.na.omit_v4_soil),]


# Number of ASVs & number of sequences post-filtering
nrow(t.seqtab.nochim.filt_v4_soil)
sum(t.seqtab.nochim.filt_v4_soil)

# Merging taxonomy information into ASV table
t.seqtab.tax_v4_soil<-merge(t.seqtab.nochim.filt_v4_soil,taxa.na.omit_v4_soil, by="row.names")

sort(colSums(t.seqtab.nochim.filt_v4_soil))

#  Creating ASV labels and make these new row names.
asvnumber_v4_soil<-as.character(c(1:nrow(t.seqtab.tax_v4_soil)))
asvnumber_v4_soil<-paste("asv_v4",labels(asvnumber_v4_soil))

row.names(t.seqtab.tax_v4_soil)<-NULL
row.names(t.seqtab.tax_v4_soil)<-asvnumber_v4_soil

write.table(t.seqtab.tax_v4_soil,"~/OneDrive - Oak Ridge National Laboratory/septoria_in_a_bag/v4_data/t.seqtab.tax_v4_soil.txt",col.names = TRUE,sep='\t')
```


```{r}
# Creates an object that has the pathway for the sequence directory
soil_v4_path_controls<-"/Users/5io/Documents/septoria_in_a_bag/v4_data/sequence_data/negative"

# Lists the files present in the sequence directory
list.files(soil_v4_path_controls)

# Creates objects for the forward and reverse reads
filtforward_v4_soil_control<-sort(list.files(soil_v4_path_controls, pattern="F_filt.fastq.gz",full.names=TRUE))
filtreverse_v4_soil_control<-sort(list.files(soil_v4_path_controls, pattern="R_filt.fastq.gz",full.names=TRUE))

# Checks number of forward and reverse files. Should be an equal number of forward and reverse files.
length(filtforward_v4_soil_control)
length(filtreverse_v4_soil_control)

filtered_qualplot_fwd_v4_soil_controls<-plotQualityProfile(filtforward_v4_soil_control, aggregate=TRUE)
filtered_qualplot_fwd_v4_soil_controls
filtered_qualplot_rev_v4_soil_controls<-plotQualityProfile(filtreverse_v4_soil_control, aggregate=TRUE)
filtered_qualplot_rev_v4_soil_controls

# Dereplicating forward and reverse reads
derepforward_v4_soil_controls<-derepFastq(filtforward_v4_soil_control,verbose=TRUE)
derepreverse_v4_soil_controls<-derepFastq(filtreverse_v4_soil_control,verbose=TRUE)

# Assigning the sample names to the dereplicated sequence objects
#names(derepforward_v4_soil)<-samplenames_v4_soil
#names(derepreverse_v4_soil)<-samplenames_v4_soil

# Learning errors for forward and reverse reads. 
errorforward_v4_soil_control<-learnErrors(derepforward_v4_soil_controls, multithread = TRUE)
errorreverse_v4_soil_control<-learnErrors(derepreverse_v4_soil_controls,multithread = TRUE)

# Error plots for forward & reverse reads
errplots_fwd_v4_soil_control<-plotErrors(errorforward_v4_soil_control, nominalQ=TRUE)
errplots_fwd_v4_soil_control
errplots_rev_v4_soil_control<-plotErrors(errorreverse_v4_soil_control,nominalQ = TRUE)
errplots_rev_v4_soil_control


# Denoising with dada2
dadaforwardreads_v4_soil_control<-dada(derepforward_v4_soil_controls,err=errorforward_v4_soil_control,multithread = TRUE,pool=TRUE)
dadareversereads.ds_v4_soil_control<-dada(derepreverse_v4_soil_controls,err=errorreverse_v4_soil_control,multithread = TRUE,pool=TRUE)


# Merging forward and reverse reads using mergePairs. 
merge_v4_soil_control<-mergePairs(dadaforwardreads_v4_soil_control,derepforward_v4_soil_controls,dadareversereads.ds_v4_soil_control,derepreverse_v4_soil_controls,verbose=TRUE)

# Creating a sequence table
seqtab_v4_soil_control<-makeSequenceTable(merge_v4_soil_control)
hist(nchar(colnames(seqtab_v4_soil_control)))

```
